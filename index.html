<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Mezzo</title>
  <link rel="stylesheet" href="stylesheets/screen.css">
  <script type="text/javascript" src="//use.typekit.net/ooz6urs.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
  <script src="javascript/jquery.pep.js"></script>
  <script>

$(document).ready(function(){

// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//                                              WEB APP STYLING
// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

$(document.body).on("touchmove", function(event) {
  event.preventDefault();
});

// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//                                                DRAG-AND-DROP
// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

var $columns = $('#grid .column');
var $row = $('#grid .row');
var snapX = {};
var snapY = {};
var halfColumn = $columns.width()/2;
var halfRow = $row.height()/2;
var $half = $('#source-container .source .half').clone();
var $fourth = $('#source-container .source .fourth').clone();
var $eighth = $('#source-container .source .eighth').clone();

function place(){
  var $pepActive = $('.pep-active');
  //generate replacement block
  if( $pepActive.attr("data-origin") === "true" ){
    switch($pepActive.attr("data-duration")){
      case "4":
        $("#source-container>.half").prepend($half.clone());
        initializePep();
        break;
      case "2":
        $("#source-container>.fourth").prepend($fourth.clone());
        initializePep();
        break;
      case "1":
        $("#source-container>.eighth").prepend($eighth.clone());
        initializePep();
        break;
      default:
        break;
    }
    $pepActive.attr("data-origin", "false");
  }
  //grid interaction
  snapX.dx = halfColumn;
  snapY.dy = halfRow;
  var columnIndex = 0;
  var columnFillStart = false;
  var columnFillCountdown;
  $columns.each(function(){
    $col = $(this);
    $col.dx = Math.abs($col.offset().left - $pepActive.offset().left);    
    //snapping to grid
    if($col.dx <= halfColumn && columnIndex + parseInt($pepActive.attr("data-duration")) <= $columns.length){
      snapX = $col;
      $pepActive.offset({left:snapX.offset().left});
      var $rows = $col.children('.row');
      $rows.each(function(){
        $row = $(this);
        $row.dy = Math.abs($row.offset().top - $pepActive.offset().top);
        if($row.dy <= halfRow){
          snapY = $row;
          $pepActive.offset({top:snapY.offset().top});
          columnFillStart = true;
          columnFillCountdown = parseInt($pepActive.attr("data-duration"));
          $col.css("border-left","1px solid rgba(255,255,255,0.15)");
        }
      });
    }
    //column coloring
    if(columnFillStart = true && columnFillCountdown > 0){
      $col.css("background-color",$pepActive.css("background-color"));
      columnFillCountdown -= 1;
    }
    columnIndex += 1;
  });
  if(snapX.dx >= halfColumn || snapY.dy >= halfRow){
    $pepActive.remove();
  } else {
    $pepActive.toggleClass("no-bg");
  }
}

function pickup(){
  var $pepActive = $('.pep-active');
  $pepActive.removeClass('no-bg');
};

function initializePep(){
  $('.pep').pep({
    activeClass: 'pep-active',
    start: pickup,
    stop: place,
    shouldEase: false
  });
};
initializePep();

// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//                                                       POINTS
// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

var level = {
  current: 1,
  score: 0,
  base: 0,
  next: 30
};

var duration = 1000;

function updateCountdown(){
  $('#exp-countdown').html(level.next - level.score + " to level " + (level.current + 1));
}

function scoreTicker(targetScore){
  var $totalScore = $('#total-score');
  var delay = duration / (targetScore - level.score);
  setTimeout(function pointLoop(){
    updateCountdown();
    $totalScore.html(level.score);
    if(level.score < targetScore){
      level.score++;
      setTimeout(pointLoop,delay);
    }
  }, 0);
}

function growExpBar(targetScore,finalScore){
  $('#experience').animate({
    width: 100 * (targetScore - level.base) / (level.next - level.base) + "%"
  }, duration);
}

function levelUp(){
  $('#level').animate(
    {"letter-spacing":"5px","opacity":"0"},
    200, 
    function(){
      var $this = $(this);
      $this.html("Level " + level.current);
      $this.animate(
        {"letter-spacing":"0px","opacity":"1"},
        200
      );
    }
  );
  level.current++;
  level.base = level.next;
  level.next = Math.floor(level.next + level.next*0.18 + 30);
  $('#experience').width(0);
  updateCountdown();
}

function addPoints(increase){
  var targetScore = level.score + increase;
  if (targetScore < level.next){
    scoreTicker(targetScore);
    growExpBar(targetScore);
  } else {
    increase = targetScore - level.next;
    scoreTicker(level.next);
    growExpBar(level.next);
    setTimeout(function(){
      levelUp();
      addPoints(increase);
    }, 1200);
  }
}

//testing the experience bar on mobile
$('#check').click(function(){
  addPoints(47);
});

});

// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//                                           NOW FOR SOME HTML!
// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  </script>
</head>
<body>
  <div id="header">
    <div id="top">
      <img id="logo" src="assets/logo.svg" alt="mezzo">
      <span id="instructions"></span>
      <div id="scoring">
        <ul>
          <li>Share Score</li>
          <li>Leaderboard</li>
        </ul>
        <div>
          <label>Total Score</label>
          <span id="total-score">0</span>
        </div>
      </div>
    </div>
    <div id="level-meter">
      <label id="exp-countdown">next level: 1000</label>
      <div id="experience"></div>
    </div>
    <ul id="controls">
      <li id="check">
        <img src="assets/score.svg">
        <br><label>score</label>
      </li>
      <li id="play">
        <img src="assets/try.svg">
        <br><label>try</label>
      </li>
      <li id="listen">
        <img src="assets/listen.svg">
        <br><label>listen</label>
      </li>
      <li id="task">
        <img src="assets/rules.svg">
        <br><label>rules</label>
      </li>
      <span id="level">Level 1<span>
    </ul>
  </div>
  <div id="play-area">
    <div id="composer">
      <div class="whole">
        <div id="grid">
          <div class="column">
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
          </div>
          <div class="column">
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
          </div>
          <div class="column">
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
          </div>
          <div class="column">
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
          </div>
          <div class="column">
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
          </div>
          <div class="column">
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
          </div>
          <div class="column">
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
          </div>
          <div class="column">
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
            <div class="row"></div>
          </div>
        </div>
        <div class="clear">Clear Board</div>
        <span class="num">1<span>
      </div>
    </div>
    <div id="source-container">
      <div class="source half">
        <div class="pep half" data-duration="4" data-origin="true"><span class="numerator">1</span><br>2</div>
      </div>
      <div class="source fourth">
        <div class="pep fourth" data-duration="2" data-origin="true"><span class="numerator">1</span><br>4</div>
      </div>
      <div class="source eighth">
        <div class="pep eighth" data-duration="1" data-origin="true"><span class="numerator">1</span><br>8</div>
      </div>
    </div>
  </div>
</body>
</html>